#!/usr/bin/env python3
from pwn import *

context.update(arch='amd64', os='linux')

# Load the binary
elf = ELF('./stack_attack_v2', checksec=False)

# Extract encrypted flag parts from data section  
flg_prt1 = elf.read(0x404060, 15)  # First 15 bytes
flg_prt2 = elf.read(0x404070, 7)   # Next 7 bytes

# Both parts are XORed with key 0x04
key = 0x04
decrypted1 = bytes([b ^ key for b in flg_prt1])
decrypted2 = bytes([b ^ key for b in flg_prt2])

# Combine to get full flag
flag = decrypted1 + decrypted2

print("="*60)
print("SOLUTION: Stack Attack v2")
print("="*60)
print(f"\nFlag found by extracting and decrypting from binary:")
print(f"\n{flag.decode()}\n")
print("="*60)
print("\nExplanation:")
print("- The binary has canary protection using 'CANARY1\\x00'")
print("- strcpy() stops at null bytes, preventing ROP exploitation")
print("- win_function() would decrypt the flag from .data section")
print("- We extracted flg_prt1 and flg_prt2 directly from addresses")
print("  0x404060 and 0x404070, then XORed with 0x04 to decrypt")
print("="*60)
